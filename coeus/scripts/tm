#!/usr/bin/env bash

sessions=`tmux ls 2>/dev/null | awk '{print $1}' | sed 's/://'`

if [[ $# == 0 ]]; then
    if [[ -z $sessions ]]; then
        sel="NEW"
    else
        sessions="$sessions NEW KILL"
        sel=`printf "%s\n" $sessions | fzf`
        [[ -z $sel ]] && exit 1
    fi

    if [[ $sel == "NEW" ]]; then
        tm new
    elif [[ $sel == "KILL" ]]; then
        tm kill
    else
        tm session $sel
    fi
else
    case $1 in
        new)
            if [[ -z $2 ]]; then
                name=`read -p "session name: " -e tmp; echo $tmp`
            else
                name=$2
            fi

            [[ -z $name ]] && echo "no session name" && exit 1
            if [[ -z $TMUX_PANE ]]; then
                tmux new -s $name -n main "triangles && echo && exec zsh"
            else
                tmux new -s $name -d -n main "triangles && echo && exec zsh"
                tmux switch -t $name
            fi
            ;;
        session)
            name=$2
            [[ -z $name ]] && echo "no session name" && exit 1
            if [[ $sessions == *"$name"* ]]; then
                if [[ -z $TMUX_PANE ]]; then
                    tmux a -t $name
                else
                    tmux switch -t $name
                fi
            else
                tm new $name
            fi
            ;;
        kill)
            if [[ -n $sessions ]]; then
                if [[ -n $2 ]]; then
                    sel=$2
                else
                    sessions="$sessions ALL"
                    sel=`printf "%s\n" $sessions | fzf`
                    [[ -z $sel ]] && exit 1
                fi

                if [[ $sel == "ALL" ]]; then
                    tmux kill-server
                else
                    tmux kill-session -t $sel
                fi
            else
                echo "no tmux sessions"
                exit 1
            fi
            ;;
        startup)
            wtitle=`wmctrl -l | rg $(xprop -root _NET_ACTIVE_WINDOW | awk '{print $5}' | sed 's/0x//') | awk '{print $4}'`
            if [[ $wtitle == "scratch" ]]; then
                if [[ $sessions == *"scratch"* ]]; then
                    tmux a -t scratch
                else
                    tmux new -s scratch -n scratch "triangles && echo && exec zsh"
                fi
            else
                if [[ ! $sessions == *"main"* ]]; then
                    tmux new -s main -n main "triangles && echo && exec zsh"
                else
                    tm
                fi
            fi
            ;;
    esac
fi

