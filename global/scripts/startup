#!/usr/bin/env bash

SYNC=false
INTERVAL="1m"

if [[ $1 == "abort" ]]; then
	dunstify "Startup" "Aborting cloud sync"
	touch /tmp/force-stop-startup-download
	exit
fi

launch-bar &
dropbox &
redshift &
eyes &
yay -Syyy &
config-wacom m &

if [[ $HOSTNAME == "coeus" ]]; then
	~/projects/archillect/get-images
	mainbg="/home/ecal/images/wallpapers/introspection.jpg"
	tallbg="/home/ecal/images/wallpapers/soup.jpg"
	altbg="/home/ecal/projects/archillect/images/img$(perl -e 'print int rand 10, "\n"; ').jpg"
	# feh --no-fehbg --bg-fill "$mainbg" "$tallbg" "$altbg"
fi

# Update volume 5 times
# for i in {0..5}; do
# 	sleep 3
# 	polybar-msg -p "$(pgrep -f "polybar $(get-bar)")" hook volume 1 &>/dev/null
# done

if [[ $SYNC == true ]]; then
	cloud backup
	cloud download all >~/.local/share/rclone/startup-sync.log
	while [[ $? != 0 ]]; do
		if [[ -f /tmp/force-stop-startup-download ]]; then
			rm /tmp/force-stop-startup-download
			exit
		fi
		dunstify "Startup" "Cloud sync failed. Retrying in $INTERVAL."
		sleep $INTERVAL
		cloud download all >~/.local/share/rclone/startup-sync.log
	done
else
	dunstify "Startup" "Cloud sync disabled"
fi
