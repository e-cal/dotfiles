#!/usr/bin/env bash
source parseargs

if [[ -n ${booleans[h]} ]]; then
    echo "TODO: help"
    exit
fi

[[ $# = 0 ]] && cloud sync && exit

get_bucket() {
    # Get existing bucket
    buckets=( `rclone lsf cloud: | tr -d "/"` )
    buckets+=" ALL"

    # Select bucket
    bucket=${args[1]}
    [[ $bucket == "all" ]] && bucket="ALL"
    [[ -z $bucket || ! " ${buckets[@]} " =~ " $bucket " ]] && \
        bucket=`printf "%s\n" ${buckets[@]} | fzf --header="buckets" --info="hidden"`
    [[ -z $bucket ]] && exit 1
    [[ $bucket == "ALL" ]] && bucket=""
}

case ${args[0]} in
    upload | u)
        get_bucket
        echo "Uploading..."
        if [[ -n ${booleans[t]} ]]; then
            rclone sync --progress $HOME/cloud/$bucket cloud:$bucket --dry-run
        else
            rclone sync --progress $HOME/cloud/$bucket cloud:$bucket
        fi
        ;;
    download | d)
        get_bucket
        echo "Downloading..."
        if [[ -n ${booleans[t]} ]]; then
            rclone sync --progress cloud:$bucket $HOME/cloud/$bucket --dry-run
        else
            rclone sync --progress cloud:$bucket $HOME/cloud/$bucket
        fi
        ;;
    backup | b)
        echo "Backing up..."
        [[ ! -d $HOME/backup ]] && mkdir $HOME/backup
        num=$(find ~/backup -name "`date +'%F'`*" | wc -l)
        if [[ $num > 0 ]]; then
            cp -r $HOME/cloud $HOME/backup/`date +"%F"`_$num
        else
            cp -r $HOME/cloud $HOME/backup/`date +"%F"`
        fi
        ;;
    autosync)
        interval=${args[1]}
        [[ -z $interval ]] && interval=5
        printf "Starting auto sync at ""$interval""m intervals\n\n"
        while true
        do
            sleep "$interval""m"
            printf "\x1b[38;2;150;150;150m`date +'%H:%M'`\x1b[0m\n"
            cloud upload all
            echo
        done
        ;;
    stat)
        pgrep -f "cloud autosync" && echo " cloud autosync is running" || echo " cloud autosync not running"
        ;;
    stop)
        pkill -f "cloud autosync" && echo " Stopped cloud autosync" || echo " cloud autosync not running"
        ;;
    *)
        echo "WARNING: boolean flags will be ignored"
        echo -n "(u)pload, (d)ownload, (q)uit? "
        rst_stty=$(stty -g)
        stty raw -echo
        sel=$( while ! head -c 1 | grep -i '[udq]'; do true; done )
        stty $rst_stty

        case $sel in
            u)
                echo upload
                cloud upload ${args[@]:1}
                ;;
            d)
                echo download
                cloud dowload ${args[@]:1}
                ;;

            q)
                echo quit
                exit
                ;;
        esac
        ;;
esac
